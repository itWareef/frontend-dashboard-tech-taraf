const UserBadgeIcon = ({ color = "#1C7E68" }) => (
  <svg width="17" height="12" viewBox="0 0 17 12" fill="none">
    <path
      d="M5.72019 6.97622C7.21899 6.97622 8.54309 7.33483 9.61892 7.80378C10.612 8.24514 11.2373 9.23821 11.2373 10.314V10.8841C11.2373 11.3899 10.8235 11.8036 10.3177 11.8036H1.12264C0.616906 11.8036 0.203125 11.3899 0.203125 10.8841V10.3232C0.203125 9.23821 0.828394 8.24514 1.82147 7.81297C2.89729 7.33483 4.22139 6.97622 5.72019 6.97622ZM13.0763 7.2061C14.0877 7.2061 14.9153 6.37854 14.9153 5.36708C14.9153 4.35562 14.0877 3.52806 13.0763 3.52806C12.0648 3.52806 11.2373 4.35562 11.2373 5.36708C11.2373 6.37854 12.0648 7.2061 13.0763 7.2061ZM16.7543 10.36C16.7543 9.61521 16.313 8.95317 15.6325 8.65892C14.8262 8.3071 13.956 8.12554 13.0763 8.12561C12.7177 8.12561 12.3774 8.16238 12.0372 8.21756C12.405 8.84282 12.6165 9.56004 12.6165 10.3232V11.8036H15.8348C16.3405 11.8036 16.7543 11.3899 16.7543 10.8841V10.36ZM5.72019 0.769531C7.24658 0.769531 8.47872 2.00167 8.47872 3.52806C8.47872 5.05445 7.24658 6.28659 5.72019 6.28659C4.1938 6.28659 2.96166 5.05445 2.96166 3.52806C2.96166 2.00167 4.1938 0.769531 5.72019 0.769531Z"
      fill={color}
    />
  </svg>
);

const UserIconSmall = ({ color = "#1C7E68" }) => (
  <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
    <path
      d="M5.74753 6.73989C7.24633 6.73989 8.57043 7.0985 9.64626 7.56745C10.6393 8.00882 11.2646 9.00189 11.2646 10.0777V10.6478C11.2646 11.1535 10.8508 11.5673 10.3451 11.5673H1.14998C0.64425 11.5673 0.230469 11.1535 0.230469 10.6478V10.0869C0.230469 9.00189 0.855738 8.00882 1.84881 7.57664C2.92464 7.0985 4.24873 6.73989 5.74753 6.73989ZM5.74753 0.533203C7.27392 0.533203 8.50607 1.76535 8.50607 3.29173C8.50607 4.81812 7.27392 6.05026 5.74753 6.05026C4.22114 6.05026 2.989 4.81812 2.989 3.29173C2.989 1.76535 4.22114 0.533203 5.74753 0.533203Z"
      fill={color}
    />
  </svg>
);

const PhoneIcon = ({ color = "#1C7E68" }) => (
  <svg width="17" height="12" viewBox="0 0 17 12" fill="none">
    <path
      d="M5.72019 6.97622C7.21899 6.97622 8.54309 7.33483 9.61892 7.80378C10.612 8.24514 11.2373 9.23821 11.2373 10.314V10.8841C11.2373 11.3899 10.8235 11.8036 10.3177 11.8036H1.12264C0.616906 11.8036 0.203125 11.3899 0.203125 10.8841V10.3232C0.203125 9.23821 0.828394 8.24514 1.82147 7.81297C2.89729 7.33483 4.22139 6.97622 5.72019 6.97622ZM13.0763 7.2061C14.0877 7.2061 14.9153 6.37854 14.9153 5.36708C14.9153 4.35562 14.0877 3.52806 13.0763 3.52806C12.0648 3.52806 11.2373 4.35562 11.2373 5.36708C11.2373 6.37854 12.0648 7.2061 13.0763 7.2061ZM16.7543 10.36C16.7543 9.61521 16.313 8.95317 15.6325 8.65892C14.8262 8.3071 13.956 8.12554 13.0763 8.12561C12.7177 8.12561 12.3774 8.16238 12.0372 8.21756C12.405 8.84282 12.6165 9.56004 12.6165 10.3232V11.8036H15.8348C16.3405 11.8036 16.7543 11.3899 16.7543 10.8841V10.36ZM5.72019 0.769531C7.24658 0.769531 8.47872 2.00167 8.47872 3.52806C8.47872 5.05445 7.24658 6.28659 5.72019 6.28659C4.1938 6.28659 2.96166 5.05445 2.96166 3.52806C2.96166 2.00167 4.1938 0.769531 5.72019 0.769531Z"
      fill={color}
    />
  </svg>
);

const LocationIcon = ({ color = "#038D7D" }) => (
  <svg width="14" height="19" viewBox="0 0 14 19" fill="none">
    <path
      d="M6.98706 4.74561C5.65988 4.74561 4.58398 5.8215 4.58398 7.14868C4.58398 8.47587 5.65988 9.55176 6.98706 9.55176C8.31425 9.55176 9.39014 8.47587 9.39014 7.14868C9.38863 5.82213 8.31362 4.74712 6.98706 4.74561ZM6.98706 8.35022C6.32347 8.35022 5.78552 7.81228 5.78552 7.14868C5.78552 6.48509 6.32347 5.94715 6.98706 5.94715C7.65066 5.94715 8.1886 6.48509 8.1886 7.14868C8.18784 7.81196 7.65034 8.34946 6.98706 8.35022Z"
      fill={color}
    />
    <path
      d="M11.6049 2.52741C9.24017 0.163242 5.47163 -0.0326718 2.87446 2.07354C0.277288 4.17975 -0.309291 7.90752 1.51555 10.7096L6.05537 17.679C6.26062 17.994 6.61119 18.1841 6.98722 18.1841C7.36325 18.1841 7.71382 17.994 7.91907 17.679L12.4591 10.7096C14.1439 8.12309 13.7877 4.71014 11.6049 2.52741ZM11.4523 10.0537L6.98724 16.9081L2.52214 10.0537C1.15538 7.95555 1.44852 5.1477 3.21914 3.37701C5.30019 1.2959 8.6743 1.2959 10.7553 3.37701C12.526 5.1477 12.8191 7.95555 11.4523 10.0537Z"
      fill={color}
    />
  </svg>
);

const renderRatingStars = (rating) => {
  const stars = [];
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 >= 0.5;

  for (let i = 1; i <= 5; i++) {
    if (i <= fullStars) {
      // نجوم كاملة
      stars.push(
        <svg
          key={i}
          className="w-6 h-6 text-secondary fill-current"
          viewBox="0 0 24 24"
        >
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
        </svg>
      );
    } else if (i === fullStars + 1 && hasHalfStar) {
      stars.push(
        <svg
          key={i}
          className="w-6 h-6 text-secondary fill-current"
          viewBox="0 0 24 24"
        >
          <defs>
            <linearGradient id="half-star" x1="0" x2="100%" y1="0" y2="0">
              <stop offset="50%" stopColor="currentColor" />
              <stop offset="50%" stopColor="#E5E7EB" />
            </linearGradient>
          </defs>
          <path
            fill="url(#half-star)"
            d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
          />
        </svg>
      );
    } else {
      stars.push(
        <svg
          key={i}
          className="w-6 h-6 text-gray-300 fill-current"
          viewBox="0 0 24 24"
        >
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
        </svg>
      );
    }
  }

  return stars;
};

import HeaderDefaultLayout from "@/components/shared/HeaderDefaultLayout/HeaderDefaultLayout";
import L from "leaflet";
import markerIcon2x from "leaflet/dist/images/marker-icon-2x.png";
import markerIcon from "leaflet/dist/images/marker-icon.png";
import markerShadow from "leaflet/dist/images/marker-shadow.png";
import Pusher from "pusher-js";
import { useEffect, useState } from "react";
import { MapContainer, Marker, Popup, TileLayer } from "react-leaflet";
import imgUser from "../../assets/imgProfile.png";
import mapImg from "../../assets/marker-icon-2x.png";
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: markerIcon2x,
  iconUrl: markerIcon,
  shadowUrl: markerShadow,
});

const stats = [
  {
    label: "إجمالي الطلبات",
    value: 15,
    icon: (
      <svg
        width="48"
        height="27"
        viewBox="0 0 48 27"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M5.31146 15.7703H42.1088V10.5135H5.31146V15.7703ZM0.0546875 26.2838H36.8521V21.027H0.0546875V26.2838ZM10.5682 0V5.25676H47.3656V0H10.5682Z"
          fill="#038D7D"
        />
      </svg>
    ),
  },
  {
    label: "إجمالي الطلبات الجديدة",
    value: 3,
    icon: (
      <svg
        width="68"
        height="39"
        viewBox="0 0 68 39"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M4.14779 30.4712H33.1823V26.3234H4.14779V30.4712ZM0 38.7667H29.0345V34.619H0V38.7667ZM8.29557 18.0278V22.1756H37.3301V18.0278H8.29557Z"
          fill="#038D7D"
        />
        <path
          d="M52.2851 29.25C53.9351 29.25 55.2851 27.9 55.2851 26.25H49.2851C49.2851 27.9 50.6351 29.25 52.2851 29.25ZM61.2851 20.25V12.75C61.2851 8.145 58.8401 4.29 54.5351 3.27V2.25C54.5351 1.005 53.5301 0 52.2851 0C51.0401 0 50.0351 1.005 50.0351 2.25V3.27C45.7451 4.29 43.2851 8.13 43.2851 12.75V20.25L40.2851 23.25V24.75H64.2851V23.25L61.2851 20.25ZM58.2851 21.75H46.2851V12.75C46.2851 9.03 48.5501 6 52.2851 6C56.0201 6 58.2851 9.03 58.2851 12.75V21.75ZM45.6551 2.37L43.5101 0.225C39.9101 2.97 37.5401 7.2 37.3301 12H40.3301C40.5453 8.14639 42.5057 4.60115 45.6551 2.37ZM64.2401 12H67.2401C67.0151 7.2 64.6451 2.97 61.0601 0.225L58.9301 2.37C62.0654 4.61173 64.0176 8.15213 64.2401 12Z"
          fill="#038D7D"
        />
      </svg>
    ),
  },
  {
    label: "إجمالي الطلبات المعلقة",
    value: 5,
    icon: (
      <svg
        width="63"
        height="38"
        viewBox="0 0 63 38"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M4.59249 28.3624H36.7399V23.7699H4.59249V28.3624ZM0 37.5474H32.1474V32.9549H0V37.5474ZM9.18498 14.585V19.1774H41.3324V14.585H9.18498Z"
          fill="#038D7D"
        />
        <path
          d="M40.332 1.36734C40.332 0.609606 40.9416 0 41.6994 0H60.8421C61.5999 0 62.2095 0.609606 62.2095 1.36734C62.2095 2.12507 61.5999 2.73468 60.8421 2.73468H60.3864V3.81716C60.3864 6.11315 59.4748 8.31799 57.8511 9.9417L53.2021 14.585L57.8454 19.2282C59.4748 20.8519 60.3864 23.0568 60.3864 25.3528V26.4352H60.8421C61.5999 26.4352 62.2095 27.0448 62.2095 27.8026C62.2095 28.5603 61.5999 29.1699 60.8421 29.1699H41.6994C40.9416 29.1699 40.332 28.5603 40.332 27.8026C40.332 27.0448 40.9416 26.4352 41.6994 26.4352H42.1552V25.3528C42.1552 23.0568 43.0667 20.8519 44.6904 19.2282L49.3394 14.585L44.6904 9.9417C43.0667 8.31799 42.1552 6.11315 42.1552 3.81716V2.73468H41.6994C40.9416 2.73468 40.332 2.12507 40.332 1.36734ZM46.6275 21.1653C46.4053 21.3875 46.2002 21.6268 46.0179 21.8774H56.5236C56.3413 21.6268 56.1362 21.3875 55.914 21.1653L51.2708 16.5163L46.6275 21.1596V21.1653ZM56.5236 7.29248C57.2529 6.28976 57.6517 5.07055 57.6517 3.81716V2.73468H44.8898V3.81716C44.8898 5.07625 45.2886 6.28976 46.0179 7.29248H56.5236Z"
          fill="#038D7D"
        />
      </svg>
    ),
  },
  {
    label: "عدد المشرفين",
    value: 7,
    icon: (
      <svg
        width="55"
        height="35"
        viewBox="0 0 55 35"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M37.1644 14.7525C41.2459 14.7525 44.5161 11.4578 44.5161 7.37624C44.5161 3.29472 41.2459 0 37.1644 0C33.0829 0 29.7882 3.29472 29.7882 7.37624C29.7882 11.4578 33.0829 14.7525 37.1644 14.7525ZM17.4944 14.7525C21.576 14.7525 24.8461 11.4578 24.8461 7.37624C24.8461 3.29472 21.576 0 17.4944 0C13.4129 0 10.1182 3.29472 10.1182 7.37624C10.1182 11.4578 13.4129 14.7525 17.4944 14.7525ZM17.4944 19.67C11.7656 19.67 0.283203 22.5467 0.283203 28.2756V34.4224H34.7057V28.2756C34.7057 22.5467 23.2233 19.67 17.4944 19.67ZM37.1644 19.67C36.4514 19.67 35.64 19.7191 34.7794 19.7929C37.6316 21.8582 39.6232 24.6366 39.6232 28.2756V34.4224H54.3757V28.2756C54.3757 22.5467 42.8933 19.67 37.1644 19.67Z"
          fill="#038D7D"
        />
      </svg>
    ),
  },
  {
    label: "عدد العملاء",
    value: 11,
    icon: (
      <svg
        width="62"
        height="31"
        viewBox="0 0 62 31"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M30.7549 17.1161C34.8881 17.1161 38.5396 18.1051 41.5064 19.3983C44.245 20.6154 45.9693 23.354 45.9693 26.3208V27.893C45.9693 29.2876 44.8282 30.4287 43.4335 30.4287H18.0763C16.6816 30.4287 15.5405 29.2876 15.5405 27.893V26.3462C15.5405 23.354 17.2648 20.6154 20.0034 19.4236C22.9702 18.1051 26.6217 17.1161 30.7549 17.1161ZM10.4691 17.7501C13.2584 17.7501 15.5405 15.4679 15.5405 12.6786C15.5405 9.88932 13.2584 7.60717 10.4691 7.60717C7.67978 7.60717 5.39763 9.88932 5.39763 12.6786C5.39763 15.4679 7.67978 17.7501 10.4691 17.7501ZM13.3345 20.5394C12.3962 20.3872 11.458 20.2858 10.4691 20.2858C7.95871 20.2858 5.57513 20.8183 3.41976 21.7565C1.54185 22.5592 0.32439 24.4053 0.326174 26.4476L0.326173 27.893C0.326173 29.2876 1.46725 30.4287 2.8619 30.4287H11.7369V26.3462C11.7369 24.2415 12.3202 22.2637 13.3345 20.5394ZM51.0407 17.7501C53.83 17.7501 56.1122 15.4679 56.1122 12.6786C56.1122 9.88932 53.83 7.60717 51.0407 7.60717C48.2514 7.60717 45.9693 9.88932 45.9693 12.6786C45.9693 15.4679 48.2514 17.7501 51.0407 17.7501ZM61.1836 26.4476C61.1836 24.3937 59.9665 22.5679 58.09 21.7565C55.8665 20.7863 53.4667 20.2856 51.0407 20.2858C50.0518 20.2858 49.1136 20.3872 48.1753 20.5394C49.1896 22.2637 49.7728 24.2415 49.7728 26.3462V30.4287H58.6479C60.0425 30.4287 61.1836 29.2876 61.1836 27.893V26.4476ZM30.7549 0C34.9642 0 38.3621 3.39787 38.3621 7.60717C38.3621 11.8165 34.9642 15.2143 30.7549 15.2143C26.5456 15.2143 23.1477 11.8165 23.1477 7.60717C23.1477 3.39787 26.5456 0 30.7549 0Z"
          fill="#038D7D"
        />
      </svg>
    ),
  },
];

export default function DashboardMapPage() {
  const [locations, setLocations] = useState([]);

  useEffect(() => {
    const pusher = new Pusher("19eb2dc80c8ede461867", {
      cluster: "ap2",
    });

    const channel = pusher.subscribe("gps-tracking");

    channel.bind("location.updated", (data) => {
      const updatedLocation = data.data[0];

      setLocations((prev) => {
        const exists = prev.find((item) => item.id === updatedLocation.id);
        if (exists) {
          return prev.map((item) =>
            item.id === updatedLocation.id ? updatedLocation : item
          );
        } else {
          return [...prev, updatedLocation];
        }
      });
      console.log("Updated location:", updatedLocation);
    });

    return () => {
      pusher.unsubscribe("gps-tracking");
      pusher.disconnect();
    };
  }, []);

  const customIcon = L.icon({
    iconUrl: mapImg,
    iconSize: [35, 45],
    iconAnchor: [17, 45],
    popupAnchor: [0, -45],
  });

  return (
    <>
      <HeaderDefaultLayout />
      <div className="h-[600px] rounded-md overflow-hidden bg-primary p-5">
        <MapContainer
          center={[24.7136, 46.6753]}
          zoom={11}
          style={{ height: "100%", width: "100%" }}
        >
          <TileLayer
            attribution='&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>'
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          />

          {locations.map((marker) => (
            <Marker
              key={marker.id}
              position={[
                parseFloat(marker.latitude),
                parseFloat(marker.longitude),
              ]}
              icon={customIcon}
            >
              {/* /node_modules/leaflet/dist/images/marker-icon.png */}
              <Popup className="custom-popup">
                <div className="flex gap-4  w-[420px]">
                  <div className="flex-shrink-0  w-[150px] h-[150px]">
                    <img
                      src={marker.image || imgUser}
                      alt={marker.name}
                      className="w-full  h-full rounded-full object-cover border-10 border-secondary"
                    />
                  </div>

                  {/* Data */}
                  <div className="flex-1 ">
                    <div className="flex items-center gap-2 pb-2 border-b border-muted">
                      <UserBadgeIcon color="#1C7E68" />
                      <span className="text-sm font-semibold text-primary">
                        {marker.position || "مشرف صيانة"}
                      </span>
                    </div>

                    {/* الصف الثاني: الاسم والهاتف */}
                    <div className="flex flex-col sm:flex-row gap-4 py-2 border-b border-muted">
                      <div className="flex items-center gap-2">
                        <UserIconSmall color="#1C7E68" />
                        <span className="text-sm  text-primary font-bold">
                          {marker.name || "عبدالرحمن علي"}
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        <PhoneIcon color="#1C7E68" />
                        <span className="text-sm  text-primary font-bold">
                          {marker.phone || "01008034761"}
                        </span>
                      </div>
                    </div>

                    {/* الصف الثالث: العنوان */}
                    <div className="flex items-center gap-2 py-2 border-b border-muted">
                      <LocationIcon color="#038D7D" />
                      <span className="text-sm font-bold text-primary">
                        {marker.address || "34 حي النزهة"}
                      </span>
                    </div>

                    {/* الصف الرابع: التقييم */}
                    <div className="">
                      <span className="text-sm  text-primary text-start block ">
                        متوسط تقييم المشرف
                      </span>
                      <div className="flex justify-end items-center gap-1">
                        {renderRatingStars(marker.rating || 5)}
                      </div>
                    </div>
                  </div>
                </div>
              </Popup>
            </Marker>
          ))}
        </MapContainer>
      </div>

      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 my-6 text-center">
        {stats.map((item, index) => (
          <div key={index} className="flex flex-col items-center">
            <div className="w-10 h-10 rounded-full flex items-center justify-center">
              {" "}
              {item.icon}
            </div>
            <h5 className="text-sm text-primary mt-1">{item.label}</h5>
            <span className="text-2xl  text-primary">{item.value}</span>
          </div>
        ))}
      </div>
    </>
  );
}
